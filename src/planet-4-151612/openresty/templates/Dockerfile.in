FROM ${BUILD_NAMESPACE}/${GOOGLE_PROJECT_ID}/ubuntu:${SOURCE_VERSION}

MAINTAINER Raymond Walker <raymond.walker@greenpeace.org>

EXPOSE 80
EXPOSE 443

ENV \
    APP_GID="1000" \
    APP_GROUP="nginx" \
    APP_UID="1000" \
    APP_USER="nginx" \
    NGX_PAGESPEED_RELEASE="${NGX_PAGESPEED_RELEASE}" \
    NGX_PAGESPEED_VERSION="${NGX_PAGESPEED_VERSION}" \
    OPENRESTY_VERSION="${OPENRESTY_VERSION}" \
    OPENRESTY_SOURCE="${OPENRESTY_SOURCE}" \
    OPENSSL_VERSION="${OPENSSL_VERSION}"

COPY . /app/

RUN set -ex && \
    groupadd -g "${APP_GID}" "${APP_GROUP}" && \
    useradd -r -s /usr/sbin/nologin "${APP_USER}" -u "${APP_UID}" -g "${APP_GID}" && \
    apt-get update && \
    bash /app/bin/install_openresty.sh && \
  	rm -Rf /tmp/* /var/tmp/* /var/lib/apt/lists/* && \
    rm -fr /usr/share/man/* /usr/share/doc/* /usr/share/locale/* && \
    mkdir -p /etc/nginx/ssl /app/www && \
    echo "$(nginx -V 2>&1)" > /app/www/index.html && \
    echo "TEST-DATA-ONLY" >> /app/www/index.html

ENV \
    CLOUDFLARE_ENABLED="false" \
    CHOWN_APP_DIR="false" \
    OPENRESTY_FASTCGI_BACKEND="php-fpm:9000" \
    OPENRESTY_KEEPALIVE_TIMEOUT="30" \
    OPENRESTY_MAX_WORKER_PROCESSES="8" \
    OPENRESTY_SENDFILE="on" \
    PAGESPEED_DISABLE_FILTERS="" \
    PAGESPEED_REBEACON_KEY="uwuudeL7iedoo7Meengi" \
    PAGESPEED_REWRITE_LEVEL="CoreFilters" \
    REDIS_FASTCGI_CACHE_SERVER="redis:6379" \
    UPLOAD_MAX_SIZE="50M" \
    PAGESPEED_ENABLED="false" \
    PHP_ENABLED="false" \
    REDIS_FASTCGI_CACHE_ENABLED="false" \
    SSL_ENABLED="false"
